---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# idbrms: Infectious Disease Modelling using brms

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Codecov test coverage](https://codecov.io/gh/epiforecasts/brms.ide/branch/master/graph/badge.svg)](https://codecov.io/gh/epiforecasts/brms.ide?branch=master)

Provides population-level infectious disease models as an extension of `brms`.

## Installation

You can install the unstable development version from [GitHub](https://github.com/) with:

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("epiforecasts/idbrms")
```

## Example

* Load `idbrms`, `brms` and `data.table` (used for manipulating data).

```{r packages, message = FALSE}
library(idbrms)
library(brms)
library(data.table)
```

* Define toy data with a fixed 5 day lag between observations.

```{r toy-data}
dt <- data.table(
  region = "France", cases = seq(10, 500, by = 10),
  date = seq(as.Date("2020-10-01"), by = "days", length.out = 50))
dt[, deaths := as.integer(shift(cases, 5) * 0.1)]
dt[is.na(deaths), deaths := 0]
```

* Prepare the data to be fit using the convolution model. 

```{r prep-data}
dt <- prepare(dt, model = "convolution", location = "region",
              primary = "cases", secondary = "deaths")
head(dt, 10)
```

* Fit the model.

```{r fit-model-eval, include = FALSE}
fit <- idbrm(data = dt)
summary(fit)
```

```{r fit-model, eval = FALSE}
fit <- idbrm(data = dt)
summary(fit)
```

* Expose model stan functions.

```{r expose-fns-eval, eval = FALSE}
expose_functions(fit)
```

```{r expose-fns, include = FALSE}
expose_functions(fit)
```

* Posterior predictive check. Runs without error but looks unlikely to be correct.

```{r pred-check}
pp_check(fit)
```

* Plot conditional effects (fails with due to mismatched vector sizes in the stan dot product + there are no variables in this model so should always fail).

```{r effect-plot, eval = FALSE}
plot(conditional_effects(fit), ask = FALSE)
```